variables:
  IMAGE_NAME: "$REGISTRY_USER/demo-app"
  IMAGE_TAG: python-app-1.1
  IMAGE_NAME_TAG: ${IMAGE_NAME}:${IMAGE_TAG}

stages:
  - test
  - build
  - deploy

run_test:
  stage: test
  image: python:3.9-slim-bookworm
  before_script:
    - apt-get update && apt-get install make
  script: 
    - make test

build_image:
  stage: build
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo $REGISTRY_PASSWORD | docker login -u $REGISTRY_USER --password-stdin
  script:
    - docker build -t $IMAGE_NAME_TAG .
    - docker push $IMAGE_NAME_TAG

deploy:
  stage: deploy
  before_script:
    - chmod 400 $SSH_KEY
  script:
    - cat $SSH_KEY
    - ssh -o StrictHostKeyChecking=no -i $SSH_KEY root@178.208.64.161 "
        echo $REGISTRY_PASSWORD | docker login -u $REGISTRY_USER --password-stdin &&
        docker ps -qf 'name=server' | xargs docker stop | xargs docker rm &&
        docker run --name server -d -p 5000:5000 $IMAGE_NAME_TAG"

